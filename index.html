<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INFOPETO - INTELIGÊNCIA</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>

    <style>
        :root { 
            --bg-body: #050505; 
            --bg-card: #141414; 
            --text-main: #e0e0e0; 
            --accent: #FFD700; /* Amarelo Tático */
            --alert: #d32f2f; 
            --border: #333; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            overflow-x: hidden;
        }

        /* LOADERS E STATUS */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
        .spinner {
            border: 4px solid #333; border-top: 4px solid var(--accent);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #sync-status { 
            font-size: 10px; font-weight: bold; color: #888; 
            background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px;
            border: 1px solid #333;
        }

        /* LAYOUT PRINCIPAL */
        .security-banner { 
            background: repeating-linear-gradient(45deg, var(--alert), var(--alert) 10px, #b71c1c 10px, #b71c1c 20px); 
            color: #fff; text-align: center; font-weight: bold; font-size: 0.75rem; padding: 8px; 
            border-bottom: 2px solid #000; text-transform: uppercase; letter-spacing: 1px;
        }

        .top-bar { 
            background: #111; border-bottom: 2px solid var(--accent); padding: 15px; 
            position: sticky; top: 0; z-index: 100; 
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8); 
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 45px; width: auto; }
        .title-box h1 { margin: 0; font-size: 1.2rem; color: var(--accent); font-weight: 900; line-height: 1; }
        .title-box p { margin: 0; font-size: 0.6rem; color: #888; letter-spacing: 2px; }

        .controls-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        
        /* BOTÕES E INPUTS */
        button { 
            padding: 10px 15px; border: 1px solid #444; border-radius: 4px; cursor: pointer; 
            font-weight: bold; font-size: 0.75rem; text-transform: uppercase; white-space: nowrap;
            display: flex; align-items: center; gap: 5px; 
        }
        .btn-gold { background: var(--accent); color: #000; border-color: var(--accent); }
        .btn-dark { background: #222; color: #fff; }
        .btn-danger { background: #500; color: #fff; border-color: #f00; }

        .search-input { 
            flex: 1; background: #000; border: 1px solid #444; color: #fff; 
            padding: 10px; border-radius: 4px; min-width: 150px; 
        }
        .filter-select { 
            background: #000; border: 1px solid #444; color: var(--accent); 
            padding: 10px; border-radius: 4px; font-weight: bold; 
        }

        /* GRID DE CARDS */
        .grid-container { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; padding: 15px; padding-bottom: 80px; 
        }

        .card { 
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; 
            overflow: hidden; position: relative; display: flex; flex-direction: column; 
            cursor: pointer; transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); border-color: var(--accent); }

        .card-img-area { 
            width: 100%; height: 200px; background: #000; position: relative; 
            border-bottom: 2px solid var(--accent); 
        }
        /* CORREÇÃO FOTO CARD: Corta corpo, foca rosto */
        .card-img { width: 100%; height: 100%; object-fit: cover; object-position: top; }
        
        .status-badge { 
            position: absolute; top: 5px; right: 5px; padding: 3px 6px; 
            background: rgba(0,0,0,0.9); color: #fff; font-size: 0.6rem; font-weight: bold; 
            border: 1px solid #fff; border-radius: 3px; 
        }

        .card-info { padding: 10px; text-align: center; }
        .card-vulgo { color: var(--accent); font-size: 1.1rem; font-weight: 900; margin-bottom: 3px; }
        .card-sub { color: #888; font-size: 0.7rem; font-weight: bold; }

        /* DASHBOARD (FICHA) */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 2000; display: none; overflow-y: auto;
        }
        .dash-container { 
            padding: 20px; max-width: 800px; margin: 0 auto; 
            background: #111; min-height: 100vh;
        }
        
        /* FOTO DA FICHA: MOSTRA TUDO (Contain) */
        .main-photo-box { 
            width: 100%; background: #000; border: 2px solid #333; margin-bottom: 15px; 
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .main-photo { 
            max-width: 100%; max-height: 50vh; object-fit: contain; 
        }
        .zoom-hint {
            position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7);
            color: #fff; font-size: 10px; padding: 2px 5px; pointer-events: none;
        }

        .gallery { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; }
        .thumb { 
            width: 60px; height: 60px; object-fit: cover; object-position: top; 
            border: 1px solid #444; flex-shrink: 0; 
        }

        .dash-header { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 15px; }
        .dash-vulgo { font-size: 2.5rem; color: var(--accent); font-weight: 900; line-height: 1; margin: 0; }
        
        .info-row { margin-bottom: 15px; }
        .info-label { color: #555; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; display: block; }
        .info-val { color: #fff; font-size: 1.1rem; border-bottom: 1px solid #333; padding-bottom: 2px; }
        
        .obs-box { 
            background: rgba(255, 215, 0, 0.05); border-left: 3px solid var(--accent); 
            padding: 10px; color: #ddd; white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; 
        }

        .fab-close {
            position: fixed; top: 15px; right: 15px; background: #000; color: #fff;
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--alert);
            display: flex; justify-content: center; align-items: center; font-size: 20px; z-index: 2100;
        }

        /* MODAL EDITOR */
        .modal-edit {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95);
            z-index: 3000; display: none; justify-content: center; align-items: flex-start; overflow-y: auto;
        }
        .form-box { 
            background: #1a1a1a; border: 1px solid var(--accent); padding: 20px; 
            width: 90%; max-width: 500px; margin-top: 50px; margin-bottom: 50px; border-radius: 8px;
        }
        .input-dark { 
            width: 100%; padding: 12px; background: #000; border: 1px solid #444; 
            color: #fff; margin-bottom: 15px; border-radius: 4px; font-size: 1rem;
        }

        /* FULLSCREEN VIEWER */
        #fullscreen-viewer { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 5000; justify-content: center; align-items: center; 
        }
        #fs-img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* IMPRESSÃO (PDF) */
        #print-area { display: none; }
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; background: white; color: black; font-family: Arial; }
            @page { margin: 0.5cm; }
            
            .print-header-report { text-align: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .print-card { border: 2px solid #000; margin-bottom: 10px; page-break-inside: avoid; display: flex; }
            .print-img-col { width: 30%; padding: 5px; border-right: 1px solid #000; display: flex; flex-direction: column; gap: 5px; }
            .print-main-img { width: 100%; object-fit: contain; max-height: 200px; border: 1px solid #000; }
            .print-info-col { width: 70%; padding: 10px; }
            .print-vulgo { font-size: 20pt; font-weight: 900; color: #d32f2f; text-transform: uppercase; }
            .print-label { font-size: 8pt; font-weight: bold; color: #555; margin-top: 5px; }
            .print-val { font-size: 11pt; border-bottom: 1px solid #ccc; width: 100%; display: block; }
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <h3 style="color:var(--accent)">SISTEMA TÁTICO</h3>
        <p style="color:#666; font-size:12px;">INICIALIZANDO BANCO DE DADOS...</p>
    </div>

    <div id="fullscreen-viewer" onclick="this.style.display='none'">
        <button style="position:absolute; top:20px; right:20px; background:red; border:none; color:white; font-size:24px;">&times;</button>
        <img id="fs-img">
    </div>

    <div id="print-area"></div>

    <div class="security-banner">
        <i class="fas fa-shield-alt"></i> USO EXCLUSIVO PETO 21ª CIPM - MONITORADO
    </div>

    <div class="top-bar">
        <div class="header-row">
            <div class="logo-area">
                <img id="logoDisplay" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Bras%C3%A3o_da_Pol%C3%ADcia_Militar_do_Estado_da_Bahia.svg" class="logo-img">
                <div class="title-box">
                    <h1>INFOPETO</h1>
                    <p>INTELIGÊNCIA TÁTICA</p>
                </div>
            </div>
            <div id="sync-status"><i class="fas fa-circle-notch fa-spin"></i> ...</div>
        </div>

        <input type="file" id="logoInput" accept="image/*" style="display:none" onchange="salvarLogo(this)">
        <input type="file" id="importInput" accept=".json" style="display:none" onchange="importarBanco(this)">

        <div class="controls-row">
            <select id="filtroCidade" class="filter-select" onchange="renderizarGrid()">
                <option value="">TODAS AS CIDADES</option>
            </select>
            <input type="text" id="busca" class="search-input" placeholder="BUSCAR VULGO..." onkeyup="renderizarGrid()">
        </div>
        <div class="controls-row">
            <button class="btn-gold" onclick="abrirModal('novo')"><i class="fas fa-plus"></i> NOVO</button>
            <button class="btn-dark" onclick="sincronizarNuvem(true)"><i class="fas fa-sync"></i> SYNC</button>
            <button class="btn-dark" onclick="gerarPDFGeral()"><i class="fas fa-file-pdf"></i> PDF</button>
            <button class="btn-dark" onclick="document.getElementById('importInput').click()"><i class="fas fa-upload"></i> BACKUP</button>
        </div>
    </div>

    <div class="grid-container" id="grid">
        </div>

    <div class="overlay" id="dashboard">
        <div class="fab-close" onclick="fecharDashboard()"><i class="fas fa-times"></i></div>
        <div class="dash-container">
            <div class="main-photo-box" onclick="verFotoFullscreen(document.getElementById('d_img').src)">
                <img id="d_img" class="main-photo">
                <div class="zoom-hint"><i class="fas fa-search-plus"></i> ZOOM</div>
            </div>
            <div class="gallery" id="d_gallery"></div>

            <div class="dash-header">
                <h1 class="dash-vulgo" id="d_vulgo">VULGO</h1>
                <span id="d_cidade" style="color:#aaa; font-weight:bold;">CIDADE</span> | 
                <span id="d_status" style="color:var(--accent); font-weight:bold;">STATUS</span>
            </div>

            <div class="info-row"><span class="info-label">NOME CIVIL</span><div class="info-val" id="d_nome"></div></div>
            <div class="info-row"><span class="info-label">CRIME / ÁREA</span><div class="info-val" id="d_crime"></div></div>
            <div class="info-row">
                <span class="info-label">OBSERVAÇÕES</span>
                <div class="obs-box" id="d_obs"></div>
            </div>

            <div style="display:flex; gap:10px; margin-top:30px; padding-bottom:50px;">
                <button class="btn-gold" style="flex:1; justify-content:center; padding:15px;" onclick="imprimirFichaAtual()"><i class="fas fa-print"></i> PDF FICHA</button>
                <button class="btn-dark" style="flex:1; justify-content:center; padding:15px;" onclick="editarAtual()"><i class="fas fa-edit"></i> EDITAR</button>
                <button class="btn-danger" style="flex:1; justify-content:center; padding:15px;" onclick="apagarAtual()"><i class="fas fa-trash"></i> APAGAR</button>
            </div>
        </div>
    </div>

    <div class="modal-edit" id="modalForm">
        <div class="form-box">
            <h3 style="color:var(--accent); margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">CADASTRO</h3>
            <input type="hidden" id="editId">
            
            <div style="background:#000; padding:20px; text-align:center; border:1px dashed #555; cursor:pointer; margin-bottom:15px;" onclick="document.getElementById('fotoInput').click()">
                <i class="fas fa-camera fa-2x" style="color:var(--accent)"></i><br>ADICIONAR FOTOS
            </div>
            <input type="file" id="fotoInput" multiple accept="image/*" style="display:none" onchange="processarFotos(this.files)">
            <div id="thumbsForm" class="gallery" style="margin-bottom:15px;"></div>

            <label class="info-label">VULGO (OBRIGATÓRIO)</label>
            <input type="text" id="in_vulgo" class="input-dark">

            <label class="info-label">NOME CIVIL</label>
            <input type="text" id="in_nome" class="input-dark">

            <label class="info-label">CIDADE</label>
            <input type="text" id="in_cidade" list="datalistCidades" class="input-dark" placeholder="Selecione ou digite...">
            <datalist id="datalistCidades"></datalist>

            <label class="info-label">STATUS</label>
            <select id="in_status" class="input-dark">
                <option>EM LIBERDADE</option>
                <option>MANDADO EM ABERTO</option>
                <option>FORAGIDO</option>
                <option>PRESO</option>
                <option>ÓBITO</option>
            </select>

            <label class="info-label">CRIME / ÁREA</label>
            <input type="text" id="in_crime" class="input-dark">

            <label class="info-label">OBSERVAÇÕES</label>
            <textarea id="in_obs" class="input-dark" rows="5"></textarea>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-dark" style="flex:1; justify-content:center;" onclick="document.getElementById('modalForm').style.display='none'">CANCELAR</button>
                <button class="btn-gold" style="flex:1; justify-content:center;" onclick="salvar()">SALVAR</button>
            </div>
        </div>
    </div>

    <script>
        // ======================================================
        // CONFIGURAÇÕES DO SISTEMA
        // ======================================================
        // URL DO SCRIPT GOOGLE (A QUE VOCÊ FORNECEU)
        const API_URL = "https://script.google.com/macros/s/AKfycbwrOSaKDrs29sibcZsZclGc-3KASS0sX5dmMxLIW9H5Kob1Sxh13j2wCF-ZDKr-iBh1TQ/exec";
        
        let db; // Variável do Banco de Dados Dexie
        let dbSuspeitos = []; // Cache em memória para velocidade
        let currentId = null;
        let fotosTemp = [];
        let cidadesBase = ["HELIÓPOLIS", "FÁTIMA", "ADUSTINA", "PARIPIRANGA", "CÍCERO DANTAS", "CIPÓ", "RIBEIRA DO POMBAL", "RIBEIRA DO AMPARO", "NOVA SOURE", "BANZAÊ"];

        // --- INICIALIZAÇÃO ---
        window.onload = async function() {
            try {
                // 1. Iniciar Banco Local Dexie
                db = new Dexie("InfoPeto_DB_V3");
                db.version(1).stores({ 
                    suspeitos: '++id, vulgo, cidade', // Índices para busca rápida
                    config: 'key' 
                });

                // 2. Carregar dados locais para memória
                dbSuspeitos = await db.suspeitos.toArray();
                
                // 3. Renderizar interface
                atualizarListaCidades();
                renderizarGrid();
                
                // 4. Carregar Logo se existir
                const logo = await db.config.get('logo');
                if(logo) document.getElementById('logoDisplay').src = logo.val;

                // 5. Remover tela de loading
                document.getElementById('loading-screen').style.display = 'none';

                // 6. Sincronizar com Nuvem (Background)
                sincronizarNuvem(false);

                // Listeners
                document.addEventListener('paste', handlePaste);

            } catch (e) {
                alert("Erro Crítico ao iniciar: " + e);
                document.getElementById('loading-screen').innerHTML = "<h3 style='color:red'>ERRO DE INICIALIZAÇÃO</h3><p>Tente limpar o cache do navegador.</p>";
            }
        };

        // --- SISTEMA DE SINCRONIZAÇÃO (CHUNKED) ---
        async function sincronizarNuvem(forceUpload = false) {
            const statusDiv = document.getElementById('sync-status');
            statusDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> BUSCANDO...';
            statusDiv.style.color = 'yellow';

            try {
                // 1. BAIXAR DA NUVEM
                const res = await fetch(API_URL);
                const dataText = await res.text(); // Pega texto puro (pode ser chunks unidos)
                
                let nuvemDB = [];
                try {
                    const json = JSON.parse(dataText);
                    nuvemDB = json.suspeitos || json || [];
                } catch(e) {
                    console.log("Nuvem vazia ou erro JSON");
                }

                // 2. MESCLAR (MERGE)
                // Usamos Map para evitar duplicatas por ID
                const mapa = new Map();
                
                // Nuvem entra primeiro
                if(Array.isArray(nuvemDB)) nuvemDB.forEach(item => mapa.set(String(item.id), item));
                
                // Local entra depois (preserva edições offline recentes)
                dbSuspeitos.forEach(item => mapa.set(String(item.id), item));

                const dbFinal = Array.from(mapa.values());

                // 3. ATUALIZAR LOCAL
                await db.suspeitos.clear();
                await db.suspeitos.bulkAdd(dbFinal);
                dbSuspeitos = dbFinal; // Atualiza RAM
                renderizarGrid();

                // 4. SUBIR PARA NUVEM (Se forçado ou se local tiver mais dados)
                if(forceUpload || dbSuspeitos.length > nuvemDB.length) {
                    statusDiv.innerHTML = '<i class="fas fa-arrow-up"></i> ENVIANDO...';
                    
                    const payload = JSON.stringify({ suspeitos: dbSuspeitos });
                    
                    await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: payload
                    });
                    
                    statusDiv.innerHTML = '<i class="fas fa-check"></i> ONLINE';
                    statusDiv.style.color = '#8bc34a';
                } else {
                    statusDiv.innerHTML = '<i class="fas fa-wifi"></i> CONECTADO';
                    statusDiv.style.color = '#8bc34a';
                }

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> OFFLINE';
                statusDiv.style.color = '#d32f2f';
            }
        }

        // --- CRUD ---
        function renderizarGrid() {
            const termo = document.getElementById('busca').value.toUpperCase();
            const filtro = document.getElementById('filtroCidade').value;
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            let dadosFiltrados = dbSuspeitos.filter(s => {
                const matchTexto = !termo || s.vulgo.toUpperCase().includes(termo) || (s.nome && s.nome.toUpperCase().includes(termo));
                const matchCidade = !filtro || s.cidade === filtro;
                return matchTexto && matchCidade;
            });

            // Ordenar: Recentes primeiro
            dadosFiltrados.reverse();

            dadosFiltrados.forEach(s => {
                const img = (s.fotos && s.fotos.length > 0) ? s.fotos[0] : null;
                const imgHTML = img ? `<img src="${img}" class="card-img">` : `<div style="height:100%; display:flex; align-items:center; justify-content:center; color:#555"><i class="fas fa-user-slash fa-2x"></i></div>`;
                const isAlert = s.status.includes('ABERTO') || s.status.includes('FORAGIDO');
                const borderStyle = isAlert ? 'border-color: red;' : '';
                const badgeStyle = isAlert ? 'background: red; color: white;' : 'background: rgba(0,0,0,0.8); color: white;';

                const div = document.createElement('div');
                div.className = 'card';
                div.style = borderStyle;
                div.onclick = () => abrirDashboard(s.id);
                div.innerHTML = `
                    <div class="card-img-area">${imgHTML}</div>
                    <div class="status-badge" style="${badgeStyle}">${s.status}</div>
                    <div class="card-info">
                        <div class="card-vulgo">${s.vulgo}</div>
                        <div class="card-sub">${s.cidade}</div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        async function abrirDashboard(id) {
            const s = await db.suspeitos.get(id); // Pega do banco para garantir
            if(!s) return;
            currentId = s.id;

            document.getElementById('d_vulgo').innerText = s.vulgo;
            document.getElementById('d_cidade').innerText = s.cidade;
            document.getElementById('d_status').innerText = s.status;
            document.getElementById('d_nome').innerText = s.nome || "-";
            document.getElementById('d_crime').innerText = s.crime || "-";
            document.getElementById('d_obs').innerText = s.obs || "Sem observações.";

            const imgEl = document.getElementById('d_img');
            const galEl = document.getElementById('d_gallery');
            galEl.innerHTML = '';

            if(s.fotos && s.fotos.length > 0) {
                imgEl.src = s.fotos[0];
                s.fotos.forEach(src => {
                    const i = document.createElement('img');
                    i.src = src; i.className = 'thumb';
                    i.onclick = () => imgEl.src = src;
                    galEl.appendChild(i);
                });
            } else {
                imgEl.src = ""; // Placeholder se quiser
            }

            document.getElementById('dashboard').style.display = 'block';
        }

        function fecharDashboard() { document.getElementById('dashboard').style.display = 'none'; }

        function abrirModal(mode, data=null) {
            document.getElementById('modalForm').style.display = 'flex';
            document.getElementById('thumbsForm').innerHTML = '';
            if(mode === 'novo') {
                document.getElementById('editId').value = '';
                document.querySelectorAll('.input-dark').forEach(i => i.value = '');
                fotosTemp = [];
            } else if(data) {
                document.getElementById('editId').value = data.id;
                document.getElementById('in_vulgo').value = data.vulgo;
                document.getElementById('in_nome').value = data.nome;
                document.getElementById('in_cidade').value = data.cidade;
                document.getElementById('in_status').value = data.status;
                document.getElementById('in_crime').value = data.crime;
                document.getElementById('in_obs').value = data.obs;
                fotosTemp = [...(data.fotos||[])];
                renderThumbs();
            }
        }

        async function editarAtual() {
            const s = await db.suspeitos.get(currentId);
            abrirModal('editar', s);
        }

        async function salvar() {
            const id = document.getElementById('editId').value;
            const vulgo = document.getElementById('in_vulgo').value.toUpperCase();
            if(!vulgo) return alert("VULGO É OBRIGATÓRIO");

            const obj = {
                id: id ? parseInt(id) : Date.now(),
                vulgo: vulgo,
                nome: document.getElementById('in_nome').value.toUpperCase(),
                cidade: document.getElementById('in_cidade').value.toUpperCase(),
                status: document.getElementById('in_status').value,
                crime: document.getElementById('in_crime').value.toUpperCase(),
                obs: document.getElementById('in_obs').value,
                fotos: fotosTemp
            };

            await db.suspeitos.put(obj); // Put cria ou atualiza
            
            // Atualiza RAM e Tela
            dbSuspeitos = await db.suspeitos.toArray();
            renderizarGrid();
            
            if(id && currentId == id) abrirDashboard(parseInt(id)); // Atualiza se estiver aberto
            
            document.getElementById('modalForm').style.display = 'none';
            sincronizarNuvem(true); // Upload
        }

        async function apagarAtual() {
            if(confirm("TEM CERTEZA? Isso apagará o registro permanentemente.")) {
                await db.suspeitos.delete(currentId);
                dbSuspeitos = await db.suspeitos.toArray();
                fecharDashboard();
                renderizarGrid();
                sincronizarNuvem(true);
            }
        }

        // --- FOTOS E IMPORTAÇÃO ---
        function renderThumbs() {
            const div = document.getElementById('thumbsForm'); div.innerHTML = '';
            fotosTemp.forEach((src,idx) => {
                const i = document.createElement('img'); i.src = src; i.className = 'thumb';
                i.onclick = () => { fotosTemp.splice(idx,1); renderThumbs(); }; // Click remove
                div.appendChild(i);
            });
        }

        async function processarFotos(files) {
            for(let f of files) fotosTemp.push(await comprimir(f));
            renderThumbs();
        }

        async function handlePaste(e) {
            if(document.getElementById('modalForm').style.display !== 'flex') return;
            for(let item of e.clipboardData.items) {
                if(item.type.indexOf('image') === 0) fotosTemp.push(await comprimir(item.getAsFile()));
            }
            renderThumbs();
        }

        function comprimir(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const max = 600; // Limite seguro para nuvem
                        let w = img.width, h = img.height;
                        if(w > h) { if(w > max){ h*=max/w; w=max; } } 
                        else { if(h > max){ w*=max/h; h=max; } }
                        cvs.width = w; cvs.height = h;
                        cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                        r(cvs.toDataURL('image/jpeg', 0.6));
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // --- IMPORTAR BACKUP (COM COMPATIBILIDADE) ---
        async function importarBanco(input) {
            if(!input.files.length) return;
            try {
                const txt = await input.files[0].text();
                const json = JSON.parse(txt);
                // Tenta achar a lista onde quer que ela esteja
                const lista = Array.isArray(json) ? json : (json.suspeitos || json.registros || []);
                
                if(lista.length > 0) {
                    await db.suspeitos.clear();
                    // Normalização de dados antigos
                    const normalizados = lista.map(i => ({
                        id: i.id || Date.now() + Math.random(),
                        vulgo: i.vulgo || "S/VULGO",
                        nome: i.nome || "",
                        cidade: i.cidade || "OUTROS",
                        status: i.status || "EM LIBERDADE",
                        crime: i.crime || "",
                        obs: i.obs || i.observacoes || "",
                        fotos: i.fotos || i.fotos_base64 || []
                    }));
                    await db.suspeitos.bulkAdd(normalizados);
                    dbSuspeitos = await db.suspeitos.toArray();
                    renderizarGrid();
                    alert("Backup importado com sucesso!");
                    sincronizarNuvem(true);
                } else {
                    alert("Arquivo inválido ou vazio.");
                }
            } catch(e) {
                alert("Erro ao importar: " + e);
            }
            input.value = '';
        }

        // --- AUXILIARES ---
        function atualizarListaCidades(extras=[]) {
            const todas = [...new Set([...cidadesBase, ...dbSuspeitos.map(s=>s.cidade)])].sort();
            document.getElementById('datalistCidades').innerHTML = todas.map(c=>`<option value="${c}">`).join('');
            document.getElementById('filtroCidade').innerHTML = '<option value="">TODAS AS CIDADES</option>' + todas.map(c=>`<option value="${c}">${c}</option>`).join('');
        }

        function verFotoFullscreen(src) {
            if(!src) return;
            document.getElementById('fs-img').src = src;
            document.getElementById('fullscreen-viewer').style.display = 'flex';
        }

        async function salvarLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    await db.config.put({ key: 'logo', val: e.target.result });
                    document.getElementById('logoDisplay').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function gerarPDFGeral() {
            // PDF SIMPLES PARA IMPRESSÃO DO NAVEGADOR
            const area = document.getElementById('print-area');
            const logo = document.getElementById('logoDisplay').src;
            const hoje = new Date().toLocaleDateString('pt-BR');
            
            let html = `
                <div class="print-header-report">
                    <img src="${logo}" style="height:60px">
                    <h2>RELATÓRIO DE INTELIGÊNCIA</h2>
                    <p>DATA: ${hoje} | REGISTROS: ${dbSuspeitos.length}</p>
                </div>
            `;

            dbSuspeitos.forEach(s => {
                const img = (s.fotos && s.fotos.length > 0) ? s.fotos[0] : '';
                html += `
                    <div class="print-card">
                        <div class="print-img-col">
                            ${img ? `<img src="${img}" class="print-main-img">` : 'SEM FOTO'}
                        </div>
                        <div class="print-info-col">
                            <div class="print-vulgo">${s.vulgo}</div>
                            <span class="print-val"><b>NOME:</b> ${s.nome}</span>
                            <span class="print-val"><b>CIDADE:</b> ${s.cidade}</span>
                            <span class="print-val"><b>CRIME:</b> ${s.crime}</span>
                            <span class="print-val"><b>STATUS:</b> ${s.status}</span>
                            <div class="print-label">OBS:</div>
                            <div style="font-size:10pt;">${s.obs}</div>
                        </div>
                    </div>
                `;
            });

            area.innerHTML = html;
            window.print();
        }

        async function imprimirFichaAtual() {
            const s = await db.suspeitos.get(currentId);
            const area = document.getElementById('print-area');
            const logo = document.getElementById('logoDisplay').src;
            
            let imgsHTML = '';
            if(s.fotos) s.fotos.forEach(f => imgsHTML += `<img src="${f}" style="width:100px; border:1px solid #000; margin:2px;">`);

            area.innerHTML = `
                <div class="print-header-report">
                    <img src="${logo}" style="height:80px">
                    <h1>FICHA INDIVIDUAL</h1>
                </div>
                <div style="display:flex; gap:20px; border:2px solid #000; padding:20px;">
                    <div style="width:40%;">
                        ${s.fotos && s.fotos[0] ? `<img src="${s.fotos[0]}" style="width:100%; border:2px solid #000">` : 'SEM FOTO'}
                        <div style="margin-top:10px; display:flex; flex-wrap:wrap;">${imgsHTML}</div>
                    </div>
                    <div style="width:60%;">
                        <h1 style="color:#d32f2f; font-size:30pt; margin:0;">${s.vulgo}</h1>
                        <h2 style="background:#000; color:#fff; padding:5px;">${s.status}</h2>
                        <p><b>NOME:</b> ${s.nome}</p>
                        <p><b>CIDADE:</b> ${s.cidade}</p>
                        <p><b>CRIME/ÁREA:</b> ${s.crime}</p>
                        <hr>
                        <p><b>OBSERVAÇÕES:</b><br>${s.obs}</p>
                    </div>
                </div>
            `;
            window.print();
        }
    </script>
</body>
</html>

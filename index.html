<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE INTELIG√äNCIA - PETO 21¬™ CIPM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>

    <style>
        :root {
            --bg-body: #050505;
            --bg-card: #141414;
            --text-main: #e0e0e0;
            --accent: #FFD700; /* Amarelo Ouro */
            --alert: #d32f2f;  /* Vermelho Alerta */
            --border: #333;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0; padding: 0;
        }

        /* --- VISUALIZADOR DE FOTO FULLSCREEN --- */
        #fullscreen-viewer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 5000;
            justify-content: center; align-items: center; cursor: zoom-out;
        }
        #fs-img { max-width: 95%; max-height: 95%; border: 2px solid var(--accent); box-shadow: 0 0 20px black; }

        /* --- FAIXA DE SEGURAN√áA --- */
        .security-banner {
            background: repeating-linear-gradient(45deg, var(--alert), var(--alert) 10px, #b71c1c 10px, #b71c1c 20px);
            color: #fff; text-align: center; font-weight: bold; font-size: 0.8rem; padding: 5px;
            text-shadow: 1px 1px 2px #000; letter-spacing: 1px; border-bottom: 2px solid #000;
        }

        /* --- BARRA SUPERIOR --- */
        .top-bar {
            background: #111; border-bottom: 3px solid var(--accent); padding: 10px 20px;
            position: sticky; top: 0; z-index: 1000;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }

        .brand-area { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 50px; width: auto; object-fit: contain; }
        .title-box h1 { margin: 0; font-size: 1.5rem; color: var(--accent); text-transform: uppercase; font-weight: 900; line-height: 1; }
        .title-box p { margin: 0; font-size: 0.7rem; color: #888; letter-spacing: 2px; }

        .controls { display: flex; gap: 8px; flex-wrap: wrap; }

        button {
            padding: 8px 12px; border: 1px solid #444; border-radius: 4px; cursor: pointer;
            font-weight: bold; display: flex; align-items: center; gap: 6px; font-size: 0.8rem;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-gold { background: var(--accent); color: #000; border-color: var(--accent); }
        .btn-gold:hover { background: #ffea00; }
        .btn-dark { background: #222; color: #fff; }
        .btn-dark:hover { background: #333; border-color: #666; }
        .btn-danger { background: #500; color: #fff; border-color: #f00; }

        .search-input { background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; width: 200px; }
        .filter-select { background: #000; border: 1px solid #444; color: var(--accent); padding: 8px; border-radius: 4px; font-weight: bold; }

        /* --- GRID VISUALIZA√á√ÉO --- */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; padding: 20px; }

        .card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px;
            overflow: hidden; position: relative; display: flex; flex-direction: column;
            cursor: pointer; transition: 0.3s;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .card-img-area { width: 100%; height: 280px; background: #000; position: relative; border-bottom: 2px solid var(--accent); }
        
        /* CARD DA GRADE: MANT√âM CORTE NO ROSTO (SOLICITADO) */
        .card-img { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            object-position: top; 
        }
        
        .status-badge {
            position: absolute; top: 10px; right: 10px; padding: 4px 8px; 
            background: rgba(0,0,0,0.9); color: #fff; font-size: 0.7rem; font-weight: bold;
            border: 1px solid #fff; border-radius: 4px;
        }

        .card-info { padding: 15px; text-align: center; }
        .card-vulgo { color: var(--accent); font-size: 1.4rem; font-weight: 900; margin-bottom: 5px; }
        .card-sub { color: #888; font-size: 0.8rem; font-weight: bold; }

        /* --- DASHBOARD DETALHADO (OVERLAY) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; display: none;
            justify-content: center; align-items: center;
        }
        .dash-box {
            width: 95%; max-width: 1100px; height: 90vh; background: #111; 
            border: 1px solid var(--accent); display: flex; flex-direction: column; position: relative;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/e0/Bras%C3%A3o_da_Pol%C3%ADcia_Militar_do_Estado_da_Bahia.svg');
            background-repeat: no-repeat; background-position: center; background-size: 20%;
        }
        .dash-box::after { content: ""; position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(17,17,17,0.95); pointer-events: none; }

        .dash-content { position: relative; z-index: 2; display: flex; height: 100%; overflow: hidden; }
        
        .dash-left {
            width: 350px; background: rgba(0,0,0,0.5); border-right: 1px solid #333;
            padding: 20px; display: flex; flex-direction: column; overflow-y: auto;
        }
        
        /* FOTO NO DASHBOARD: SEM CORTE (ORIGINAL) */
        .main-photo { 
            width: 100%; 
            height: auto;
            max-height: 400px; 
            object-fit: contain; /* ALTERA√á√ÉO: MOSTRA A FOTO TODA */
            border: 2px solid #333; 
            margin-bottom: 10px; 
            background: #000;
            cursor: zoom-in; /* Indica que pode clicar */
        }
        
        .gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .thumb { 
            width: 100%; height: 80px; 
            object-fit: cover; object-position: top;
            border: 1px solid #444; cursor: pointer; opacity: 0.6; 
        }
        .thumb:hover { opacity: 1; border-color: var(--accent); }

        .dash-right { flex: 1; padding: 30px; overflow-y: auto; }
        .dash-header { border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px; }
        .dash-vulgo { font-size: 3.5rem; color: var(--accent); font-weight: 900; line-height: 1; margin: 0; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .info-label { color: #555; font-size: 0.8rem; font-weight: bold; display: block; text-transform: uppercase; }
        .info-val { color: #fff; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }

        .obs-container { 
            background: rgba(255, 215, 0, 0.05); border-left: 4px solid var(--accent); 
            padding: 15px; color: #ddd; white-space: pre-wrap; font-family: monospace; font-size: 1rem;
        }

        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 2rem; color: #fff; cursor: pointer; z-index: 10; }
        .dash-footer { position: absolute; bottom: 0; right: 0; padding: 15px; z-index: 5; display: flex; gap: 10px; }

        /* --- MODAIS --- */
        .modal-edit {
            position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        .form-box { background: #222; border: 1px solid var(--accent); padding: 25px; width: 500px; max-height: 90vh; overflow-y: auto; }
        .input-dark { width: 100%; padding: 10px; background: #111; border: 1px solid #444; color: #fff; margin-bottom: 10px; box-sizing: border-box; }

        /* √ÅREA DE IMPRESS√ÉO OCULTA */
        #print-area { display: none; }

        /* ================= ESTILOS DE IMPRESS√ÉO (PDF NOVO LAYOUT) ================= */
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area { display: block !important; width: 100%; height: 100%; background: white; color: black; }
            @page { margin: 0.5cm; size: A4; }
            body { background: white !important; -webkit-print-color-adjust: exact; }

            /* CONTAINER PRINCIPAL DA FICHA */
            .print-card-container {
                border: 2px solid #000;
                margin-bottom: 15px;
                page-break-inside: avoid;
                font-family: Arial, sans-serif;
                background: #fff;
            }

            /* BARRA PRETA - CABE√áALHO DA CIDADE */
            .print-header-bar {
                background-color: #000;
                color: #FFD700; /* Amarelo */
                padding: 5px 10px;
                font-weight: 900;
                text-transform: uppercase;
                font-size: 14pt;
                border-bottom: 1px solid #000;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .print-header-status {
                color: #fff; 
                font-size: 10pt; 
                background: #d32f2f; 
                padding: 2px 6px; 
                border-radius: 2px;
            }

            /* CORPO: DUAS COLUNAS */
            .print-body {
                display: flex;
                flex-direction: row;
                border-top: 1px solid #000;
            }

            /* COLUNA ESQUERDA: TEXTO */
            .print-col-text {
                flex: 7; /* 70% largura */
                padding: 10px;
                border-right: 1px solid #ccc;
            }

            /* COLUNA DIREITA: FOTOS */
            .print-col-photos {
                flex: 3; /* 30% largura */
                padding: 5px;
                display: flex;
                flex-direction: column;
                gap: 5px;
                background: #f9f9f9;
            }

            /* ESTILOS DE TEXTO */
            .print-label { font-size: 8pt; font-weight: bold; color: #555; text-transform: uppercase; margin-top: 5px; }
            .print-value-vulgo { font-size: 24pt; font-weight: 900; color: #d32f2f; text-transform: uppercase; margin-bottom: 5px; line-height: 1; }
            .print-value { font-size: 12pt; font-weight: bold; color: #000; margin-bottom: 5px; border-bottom: 1px solid #eee; width: 100%; display: block;}
            .print-obs-box { 
                margin-top: 15px; 
                font-size: 10pt; 
                line-height: 1.3; 
                text-align: justify; 
                white-space: pre-wrap; 
                color: #000;
            }

            /* FOTOS NA IMPRESS√ÉO */
            .print-photo-main {
                width: 100%;
                height: auto;
                max-height: 250px;
                object-fit: contain; /* Foto inteira no PDF */
                border: 2px solid #000;
                background: #fff;
            }
            .print-photo-sec {
                width: 100%;
                height: auto;
                border: 1px solid #999;
                object-fit: contain;
            }

            /* CABE√áALHO GERAL (Primeira Pagina) */
            .print-report-header {
                text-align: center; margin-bottom: 20px; border-bottom: 4px double #000; padding-bottom: 10px;
            }
            .print-footer { text-align: center; font-size: 8pt; color: #d32f2f; margin-top: 5px; font-weight: bold; border-top: 1px solid #000; }
        }
    </style>
</head>
<body>

    <div id="fullscreen-viewer" onclick="this.style.display='none'">
        <img id="fs-img">
    </div>

    <div id="print-area"></div>

    <div class="security-banner">SISTEMA MONITORADO - USO EXCLUSIVO PETO 21¬™ CIPM</div>

    <div class="top-bar">
        <div class="brand-area">
            <img id="logoDisplay" src="https://upload.wikimedia.org/wikipedia/commons/e/e0/Bras%C3%A3o_da_Pol%C3%ADcia_Militar_do_Estado_da_Bahia.svg" class="logo-img">
            <div class="title-box">
                <h1>InfoPETO</h1>
                <p>21¬™ COMPANHIA INDEPENDENTE</p>
            </div>
        </div>

        <input type="file" id="logoInput" accept="image/*" style="display:none" onchange="salvarLogo(this)">
        <input type="file" id="importInput" accept=".json" multiple style="display:none" onchange="importarBanco(this)">

        <div class="controls">
            <button class="btn-dark" onclick="document.getElementById('logoInput').click()"><i class="fas fa-image"></i> DEFINIR LOGO</button>
            <select id="filtroCidade" class="filter-select" onchange="renderizarGrid()">
                <option value="">TODAS AS CIDADES</option>
            </select>
            <input type="text" id="busca" class="search-input" placeholder="BUSCAR VULGO..." onkeyup="renderizarGrid()">
            <button class="btn-gold" onclick="abrirModal('novo')"><i class="fas fa-plus"></i> NOVO</button>
            <button class="btn-dark" onclick="document.getElementById('importInput').click()"><i class="fas fa-upload"></i> IMPORTAR</button>
            <button class="btn-dark" onclick="fazerBackup()"><i class="fas fa-download"></i> BACKUP FULL</button>
            <button class="btn-dark" onclick="abrirModalRelatorio()"><i class="fas fa-file-pdf"></i> GERAR PDF</button>
        </div>
    </div>

    <div class="grid-container" id="grid"></div>

    <div id="modalRelatorio" class="modal-edit">
        <div class="form-box" style="width: 400px; text-align:center;">
            <h3 style="color:var(--accent); margin-top:0;">GERADOR DE RELAT√ìRIO</h3>
            <p style="color:#ccc; font-size:0.9rem; margin-bottom:20px;">SELECIONE O ESCOPO DA IMPRESS√ÉO</p>
            <div id="relMenuPrincipal" style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-dark" style="justify-content:center; padding:15px;" onclick="prepararRelatorio('geral')">üìã LISTA GERAL (TODOS)</button>
                <button class="btn-dark" style="justify-content:center; padding:15px;" onclick="mostrarOpcaoCidade()">üèôÔ∏è POR CIDADE</button>
                <button class="btn-dark" style="justify-content:center; padding:15px;" onclick="mostrarOpcaoIndividuo()">üë§ INDIVIDUAL</button>
            </div>
            <div id="relOpcaoCidade" style="display:none; text-align:left;">
                <label class="form-label">SELECIONE A CIDADE:</label>
                <select id="relCidadeSelect" class="input-dark"></select>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn-dark" style="flex:1; justify-content:center;" onclick="voltarRelatorio()">VOLTAR</button>
                    <button class="btn-gold" style="flex:1; justify-content:center;" onclick="prepararRelatorio('cidade')">GERAR</button>
                </div>
            </div>
            <div id="relOpcaoIndividuo" style="display:none; text-align:left;">
                <label class="form-label">BUSCAR INDIV√çDUO:</label>
                <input type="text" id="relBuscaInput" class="input-dark" placeholder="Digite vulgo ou nome..." onkeyup="buscarIndividuoRelatorio(this.value)">
                <div id="relResultados" style="max-height:150px; overflow-y:auto; background:#111; border:1px solid #444; margin-bottom:10px;"></div>
                <button class="btn-dark" style="width:100%; justify-content:center;" onclick="voltarRelatorio()">VOLTAR</button>
            </div>
            <button class="btn-danger" style="width:100%; margin-top:20px; justify-content:center;" onclick="document.getElementById('modalRelatorio').style.display='none'">FECHAR</button>
        </div>
    </div>

    <div class="overlay" id="dashboard">
        <div class="dash-box">
            <div class="close-btn" onclick="fecharDashboard()">&times;</div>
            <div class="dash-content">
                <div class="dash-left">
                    <img id="d_img" class="main-photo" onclick="verFotoFullscreen(this.src)" title="Clique para ampliar">
                    <div class="gallery" id="d_gallery"></div>
                </div>
                <div class="dash-right">
                    <div class="dash-header">
                        <h1 class="dash-vulgo" id="d_vulgo">VULGO</h1>
                        <div style="margin-top:5px; font-size:1.2rem;">
                            <span id="d_cidade">CIDADE</span> | <span id="d_status" style="color:var(--accent); font-weight:bold;">STATUS</span>
                        </div>
                    </div>
                    <div class="info-grid">
                        <div><span class="info-label">NOME CIVIL</span><div class="info-val" id="d_nome"></div></div>
                        <div><span class="info-label">CRIME / √ÅREA</span><div class="info-val" id="d_crime"></div></div>
                    </div>
                    <div>
                        <span class="info-label" style="color:var(--accent); margin-bottom:5px;">OBSERVA√á√ïES OPERACIONAIS</span>
                        <div class="obs-container" id="d_obs"></div>
                    </div>
                </div>
            </div>
            <div class="dash-footer">
                <button class="btn-gold" onclick="prepararRelatorio('unico', currentId)"><i class="fas fa-file-pdf"></i> GERAR PDF (FICHA)</button>
                <button class="btn-dark" onclick="editarAtual()"><i class="fas fa-edit"></i> EDITAR</button>
                <button class="btn-danger" onclick="apagarAtual()"><i class="fas fa-trash"></i> APAGAR</button>
            </div>
        </div>
    </div>

    <div class="modal-edit" id="modalForm">
        <div class="form-box">
            <h3 style="color:var(--accent); margin-top:0;">FICHA DE CADASTRO</h3>
            <input type="hidden" id="editId">
            <div style="background:#000; padding:15px; text-align:center; border:1px dashed #555; cursor:pointer; margin-bottom:15px;" onclick="document.getElementById('fotoInput').click()">
                <i class="fas fa-camera" style="color:var(--accent)"></i> ADICIONAR FOTOS
            </div>
            <input type="file" id="fotoInput" multiple accept="image/*" style="display:none" onchange="processarFotos(this.files)">
            <div id="thumbsForm" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;"></div>
            <label class="form-label">VULGO (OBRIGAT√ìRIO)</label><input type="text" id="in_vulgo" class="input-dark">
            <label class="form-label">NOME CIVIL</label><input type="text" id="in_nome" class="input-dark">
            <label class="form-label">CIDADE (Selecione ou Digite Nova)</label><input type="text" id="in_cidade" list="datalistCidades" class="input-dark" placeholder="Ex: Heli√≥polis"><datalist id="datalistCidades"></datalist>
            <label class="form-label">STATUS</label>
            <select id="in_status" class="input-dark">
                <option>EM LIBERDADE</option><option>MANDADO EM ABERTO</option><option>FORAGIDO</option><option>PRESO</option><option>√ìBITO</option>
            </select>
            <label class="form-label">CRIME / √ÅREA</label><input type="text" id="in_crime" class="input-dark">
            <label class="form-label">OBSERVA√á√ïES</label><textarea id="in_obs" class="input-dark" rows="5"></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-dark" style="flex:1; justify-content:center;" onclick="document.getElementById('modalForm').style.display='none'">CANCELAR</button>
                <button class="btn-gold" style="flex:1; justify-content:center;" onclick="salvar()">SALVAR</button>
            </div>
        </div>
    </div>

    <script>
        const db = new Dexie("PetoSystemV12_Final");
        db.version(1).stores({ suspeitos: '++id, vulgo, nome, cidade', config: 'key' });

        let currentId = null;
        let fotosTemp = [];
        let cidadesBase = ["HELI√ìPOLIS", "F√ÅTIMA", "ADUSTINA", "PARIPIRANGA", "C√çCERO DANTAS", "CIP√ì", "RIBEIRA DO POMBAL", "RIBEIRA DO AMPARO", "NOVA SOURE", "BANZA√ä"];

        window.onload = async () => {
            await carregarConfig();
            await renderizarGrid();
            document.addEventListener('paste', handlePaste);
            atualizarListaCidades();
        };

        // --- SISTEMA DE RELAT√ìRIO PDF (LAYOUT NOVO) ---
        function abrirModalRelatorio() {
            document.getElementById('modalRelatorio').style.display = 'flex';
            voltarRelatorio(); 
        }

        function voltarRelatorio() {
            document.getElementById('relMenuPrincipal').style.display = 'flex';
            document.getElementById('relOpcaoCidade').style.display = 'none';
            document.getElementById('relOpcaoIndividuo').style.display = 'none';
        }

        async function mostrarOpcaoCidade() {
            document.getElementById('relMenuPrincipal').style.display = 'none';
            document.getElementById('relOpcaoCidade').style.display = 'block';
            const dados = await db.suspeitos.toArray();
            const cidades = [...new Set([...cidadesBase, ...dados.map(s=>s.cidade)])].sort();
            const sel = document.getElementById('relCidadeSelect');
            sel.innerHTML = cidades.map(c=>`<option value="${c}">${c}</option>`).join('');
        }

        function mostrarOpcaoIndividuo() {
            document.getElementById('relMenuPrincipal').style.display = 'none';
            document.getElementById('relOpcaoIndividuo').style.display = 'block';
            document.getElementById('relBuscaInput').value = '';
            document.getElementById('relResultados').innerHTML = '';
        }

        async function buscarIndividuoRelatorio(val) {
            if(val.length < 2) return;
            const termo = val.toUpperCase();
            const dados = await db.suspeitos.toArray();
            const filtrados = dados.filter(s => s.vulgo.includes(termo) || (s.nome && s.nome.includes(termo)));
            const container = document.getElementById('relResultados');
            container.innerHTML = filtrados.map(s => `
                <div onclick="prepararRelatorio('unico', ${s.id})" style="padding:10px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:var(--accent)">${s.vulgo}</span>
                    <span style="font-size:0.8rem; color:#888">${s.cidade}</span>
                </div>
            `).join('');
        }

        // --- GERA√á√ÉO DO HTML DO RELAT√ìRIO ---
        async function prepararRelatorio(tipo, idAlvo = null) {
            const printArea = document.getElementById('print-area');
            const logoSrc = document.getElementById('logoDisplay').src;
            let htmlContent = '';
            let dados = [];

            // Cabe√ßalho Oficial (S√≥ na primeira p√°gina)
            const headerHTML = `
                <div class="print-report-header">
                    <img src="${logoSrc}" style="height:80px; object-fit:contain;">
                    <h2 style="margin:5px 0; text-transform:uppercase;">RELAT√ìRIO DE INTELIG√äNCIA</h2>
                    <p style="margin:0;">21¬™ COMPANHIA INDEPENDENTE DE POL√çCIA MILITAR</p>
                </div>
            `;

            // Filtro de Dados
            if(tipo === 'unico' && idAlvo) {
                const s = await db.suspeitos.get(idAlvo);
                if(s) dados.push(s);
            } else if (tipo === 'geral') {
                dados = await db.suspeitos.toArray();
            } else if (tipo === 'cidade') {
                const cid = document.getElementById('relCidadeSelect').value;
                dados = await db.suspeitos.where('cidade').equals(cid).toArray();
            }
            
            // Ordenar
            dados.reverse();

            // Montar Fichas no Estilo Solicitado
            let cardsHTML = dados.map(s => {
                // Fotos: Main + Secund√°rias
                let photosHTML = '';
                if (s.fotos && s.fotos.length > 0) {
                    // Foto principal (A primeira)
                    photosHTML += `<img src="${s.fotos[0]}" class="print-photo-main">`;
                    // Demais fotos
                    for (let i = 1; i < s.fotos.length; i++) {
                        photosHTML += `<img src="${s.fotos[i]}" class="print-photo-sec">`;
                    }
                } else {
                    photosHTML = `<div style="border:1px solid #000; height:150px; display:flex; align-items:center; justify-content:center;">SEM FOTO</div>`;
                }

                return `
                    <div class="print-card-container">
                        <div class="print-header-bar">
                            <span>${s.cidade}</span>
                            <span class="print-header-status">${s.status}</span>
                        </div>
                        <div class="print-body">
                            <div class="print-col-text">
                                <div class="print-label">VULGO:</div>
                                <div class="print-value-vulgo">${s.vulgo}</div>
                                
                                <div class="print-label">NOME CIVIL:</div>
                                <span class="print-value">${s.nome || '-'}</span>
                                
                                <div class="print-label">CRIME / √ÅREA:</div>
                                <span class="print-value">${s.crime || '-'}</span>
                                
                                <div class="print-label">OBSERVA√á√ïES:</div>
                                <div class="print-obs-box">${s.obs || 'Sem observa√ß√µes registradas.'}</div>
                            </div>
                            
                            <div class="print-col-photos">
                                ${photosHTML}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            htmlContent = `
                ${headerHTML}
                <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid #000;">
                    FILTRO: ${tipo === 'geral' ? 'GERAL (TODOS)' : (tipo==='unico'?'INDIVIDUAL':document.getElementById('relCidadeSelect').value)} 
                    | REGISTROS: ${dados.length}
                </div>
                ${cardsHTML}
                <div class="print-footer">USO EXCLUSIVO DA ATIVIDADE DE INTELIG√äNCIA - PETO 21¬™ CIPM</div>
            `;

            printArea.innerHTML = htmlContent;
            document.getElementById('modalRelatorio').style.display = 'none';
            window.print();
        }

        // --- SISTEMA LOGO ---
        async function salvarLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    await db.config.put({ key: 'logo', val: e.target.result });
                    document.getElementById('logoDisplay').src = e.target.result;
                    alert("Logo salva!");
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        async function carregarConfig() {
            const logo = await db.config.get('logo');
            if (logo) document.getElementById('logoDisplay').src = logo.val;
        }

        // --- GRID E CRUD ---
        async function renderizarGrid() {
            const termo = document.getElementById('busca').value.toUpperCase();
            const filtro = document.getElementById('filtroCidade').value;
            let dados = await db.suspeitos.toArray();
            
            dados = dados.filter(s => {
                const matchTexto = !termo || s.vulgo.includes(termo) || (s.nome && s.nome.includes(termo));
                const matchCidade = !filtro || s.cidade === filtro;
                return matchTexto && matchCidade;
            });

            const cidadesAtuais = [...new Set([...cidadesBase, ...dados.map(s=>s.cidade)])].sort();
            if(document.getElementById('filtroCidade').options.length <= 1) atualizarListaCidades(cidadesAtuais);

            dados.reverse();
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            dados.forEach(s => {
                const img = (s.fotos && s.fotos.length) ? s.fotos[0] : null;
                // GRID: MANT√âM CORTE NO ROSTO (object-fit: cover + top)
                const imgHTML = img ? `<img src="${img}" class="card-img">` : `<div style="height:100%; display:flex; align-items:center; justify-content:center; color:#555">SEM FOTO</div>`;
                const isAlert = s.status.includes('ABERTO') || s.status.includes('FORAGIDO');
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => abrirDashboard(s.id);
                div.innerHTML = `<div class="card-img-area">${imgHTML}</div><div class="status-badge" style="border-color:${isAlert?'#f00':'#fff'}; color:${isAlert?'#f00':'#fff'}">${s.status}</div><div class="card-info"><div class="card-vulgo">${s.vulgo}</div><div class="card-sub">${s.cidade}</div></div>`;
                grid.appendChild(div);
            });
        }

        async function abrirDashboard(id) {
            const s = await db.suspeitos.get(id);
            if(!s) return;
            currentId = s.id;
            document.getElementById('d_vulgo').innerText = s.vulgo;
            document.getElementById('d_cidade').innerText = s.cidade;
            document.getElementById('d_status').innerText = s.status;
            document.getElementById('d_nome').innerText = s.nome || "-";
            document.getElementById('d_crime').innerText = s.crime || "-";
            document.getElementById('d_obs').innerText = s.obs || "SEM OBSERVA√á√ïES.";
            
            const imgEl = document.getElementById('d_img');
            const galEl = document.getElementById('d_gallery');
            galEl.innerHTML = '';
            
            if(s.fotos && s.fotos.length) {
                imgEl.src = s.fotos[0]; // Carrega imagem
                // Galeria de miniaturas
                s.fotos.forEach(src => {
                    const i = document.createElement('img'); i.src = src; i.className = 'thumb'; 
                    i.onclick = () => imgEl.src = src; 
                    galEl.appendChild(i);
                });
            } else { imgEl.src = ""; }
            
            document.getElementById('dashboard').style.display = 'flex';
        }

        function fecharDashboard() { document.getElementById('dashboard').style.display = 'none'; }

        // --- FULLSCREEN VIEWER ---
        function verFotoFullscreen(src) {
            if(!src) return;
            document.getElementById('fs-img').src = src;
            document.getElementById('fullscreen-viewer').style.display = 'flex';
        }

        function abrirModal(mode, data=null) {
            document.getElementById('modalForm').style.display = 'flex';
            document.getElementById('thumbsForm').innerHTML = '';
            if(mode === 'novo') {
                document.getElementById('editId').value = '';
                document.querySelectorAll('.input-dark').forEach(i => i.value = '');
                fotosTemp = [];
            } else if(data) {
                document.getElementById('editId').value = data.id;
                document.getElementById('in_vulgo').value = data.vulgo;
                document.getElementById('in_nome').value = data.nome;
                document.getElementById('in_cidade').value = data.cidade;
                document.getElementById('in_status').value = data.status;
                document.getElementById('in_crime').value = data.crime;
                document.getElementById('in_obs').value = data.obs;
                fotosTemp = [...(data.fotos||[])];
                renderThumbs();
            }
        }

        async function editarAtual() { const s = await db.suspeitos.get(currentId); abrirModal('editar', s); }

        async function salvar() {
            const id = document.getElementById('editId').value;
            const vulgo = document.getElementById('in_vulgo').value.toUpperCase();
            if(!vulgo) return alert("VULGO √â OBRIGAT√ìRIO");
            const obj = {
                vulgo, nome: document.getElementById('in_nome').value.toUpperCase(),
                cidade: document.getElementById('in_cidade').value.toUpperCase(),
                status: document.getElementById('in_status').value,
                crime: document.getElementById('in_crime').value.toUpperCase(),
                obs: document.getElementById('in_obs').value,
                fotos: fotosTemp
            };
            if(id) { await db.suspeitos.update(parseInt(id), obj); if(currentId == id) abrirDashboard(parseInt(id)); } 
            else { await db.suspeitos.add(obj); }
            document.getElementById('modalForm').style.display = 'none'; renderizarGrid();
        }

        async function apagarAtual() { if(confirm("REMOVER PERMANENTEMENTE?")) { await db.suspeitos.delete(currentId); fecharDashboard(); renderizarGrid(); } }

        async function fazerBackup() {
            const suspeitos = await db.suspeitos.toArray();
            const configs = await db.config.toArray();
            const blob = new Blob([JSON.stringify({ data: new Date(), sistema: "PETO_V12", registros: suspeitos, configuracoes: configs })], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `BACKUP_PETO_FULL_${Date.now()}.json`; a.click();
        }

        async function importarBanco(input) {
            if(!input.files.length) return;
            const txt = await input.files[0].text();
            const json = JSON.parse(txt);
            const lista = Array.isArray(json) ? json : (json.registros || []);
            if(json.configuracoes) for(let c of json.configuracoes) await db.config.put(c);
            
            // CORRE√á√ÉO CR√çTICA DE IMPORTA√á√ÉO: Normaliza√ß√£o de dados (fotos antigas vs novas)
            if(lista.length) await db.transaction('rw', db.suspeitos, async () => { 
                for(let item of lista) { 
                    delete item.id; 
                    // Garante que fotos apare√ßam mesmo se o backup for antigo (fotos_base64)
                    item.fotos = item.fotos || item.fotos_base64 || [];
                    item.obs = item.obs || item.observacoes || "";
                    await db.suspeitos.add(item); 
                } 
            });
            alert("Importa√ß√£o Completa! Fotos Restauradas."); renderizarGrid(); carregarConfig(); input.value = '';
        }

        function renderThumbs() {
            const div = document.getElementById('thumbsForm'); div.innerHTML = '';
            fotosTemp.forEach((src,idx) => {
                const i = document.createElement('img'); i.src = src; i.style.height='60px'; i.style.border='1px solid gold'; i.onclick=()=>{fotosTemp.splice(idx,1); renderThumbs()}; div.appendChild(i);
            });
        }
        async function processarFotos(files) { for(let f of files) fotosTemp.push(await comprimir(f)); renderThumbs(); }
        async function handlePaste(e) { if(document.getElementById('modalForm').style.display!=='flex') return; for(let item of e.clipboardData.items) { if(item.type.indexOf('image')===0) fotosTemp.push(await comprimir(item.getAsFile())); } renderThumbs(); }
        function comprimir(file) { return new Promise(r => { const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const cvs = document.createElement('canvas'); const max=800; let w=img.width, h=img.height; if(w>h){if(w>max){h*=max/w;w=max}}else{if(h>max){w*=max/h;h=max}} cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h); r(cvs.toDataURL('image/jpeg', 0.8)); } }; reader.readAsDataURL(file); }); }
        function atualizarListaCidades(extras=[]) {
            const lista = [...new Set([...cidadesBase, ...extras])].sort();
            document.getElementById('datalistCidades').innerHTML = lista.map(c=>`<option value="${c}">`).join('');
            document.getElementById('filtroCidade').innerHTML = `<option value="">TODAS AS CIDADES</option>` + lista.map(c=>`<option value="${c}">${c}</option>`).join('');
        }
    </script>
</body>
</html>

